# McKinsey ID SDK

Provides the browser-based, front-end flow control for McKinsey ID.

## Installation

Make sure your `.npmrc` file contains:
```
@mid:registry="https://mckinsey.jfrog.io/artifactory/api/npm/mid-npm/"
```

> You must have appropriate authentication for the JFrog registry already set up. You may obtain your
> personal credentials by logging into [https://mckinsey.jfrog.com](https://mckinsey.jfrog.com). Click on
> your profile name in the upper right, then select "Set me up".
> Choose "npm" and "mid-npm" for the dropdowns, then follow the instructions.

![JFrog Authentication](docs/media/jfrog-authn.png)

Then run:

```bash
npm i @mid/sdk
# or
yarn add @mid/sdk
```

## Config

### McKinsey ID 2.0 OIDC Flow

```javascript
const mid = new Mid({
  // config to allowÂ login via redirection to the McKinsey ID hosted login page
  loginInfo: {
    appId: "my-app-id",
    oidcConfigUrl: "https://login.mckinsey.id/.well-known/openid-configuration",
    authDriver: "mid",
  },

  // the url to redirect to when a login is complete (either successfully or failure);
  // must be registered by McKinsey ID
  redirectUrl: 'http://localhost:3000/demo/auth/callback',

  // the url to redirect to when a logout is complete; must be registered by McKinsey ID
  logoutRedirectUrl: 'http://localhost:3000/demo',
  
  // removal of hash after redirect login
  landingFn: async () => {
      window.location.hash = '';
    }
});
```

### McKinsey ID 1.0 Driver Flow

```javascript
const mid = new Mid({
  // an async function that takes an email and turns it into a LoginInfo structure, usually an API call
  emailToLoginInfo: async (email) => { /* single authN endpoint for email provided */ },

  // an async function that takes an accessToken from the IdP and produces a list of valid tenants for
  // that token. You MUST verify the access token, tenant listing is a privileged operation!
  tenantListing: async (email, accessToken) => { /* protected tenant selector callback, use accessToken to control access */ },

  // the Widget for your app's UI (react, angular, etc)
  loginWidget: new Widget(),

  // the authentication drivers to support
  drivers: {okta: oktaDriver, auth0: auth0Driver},
  
  // the url to redirect to when a login is complete (either successfully or failure);
  // must be registered at the IdP
  redirectUrl: 'http://localhost:3000/demo/auth/callback',

  // the url to redirect to when a logout is complete; must be registered at the IdP
  logoutRedirectUrl: 'http://localhost:3000/demo',

  // Optional: 'default' | 'privacy', used to signal widgets to show less information on screen (currently only supported by react widget)
  mode: 'default',
});
```

### Optional options for either config

```javascript
const mid = new Mid({
  ...baseConfig,

  // Optional: A set of additional scopes to request
  scopes: ['profile'],

  // Optional: Map of error codes to error msg to show to the end user
  errors: {
    A00: 'Invalid username / password',
    B00: 'Impossible to verify this email'
  },

  // Optional: allows implementors to define a method of managing their own cookies.
  // when `data` is null, the user is logging out and cookie data should be removed.
  setCookie: async (data) => { 
    if (!data) {
      /* logout initiated, destroy cookie */
    }
    else {
      data.tenant;      // contains the tenant id
      data.accessToken; // contains the access token
      /* some code to handle setting cookies */
    }
  },
  
  // Optional: A callback function when landing from a redirect
  landingFn: async ({midfetch, idToken, accessToken, tenant}) => {}
});
```

## Usage

```javascript
const mid = new Mid({...});

/**
 * Determine if the user is authenticated via SSO or any other mechanism.
 *
 * IMPORTANT NOTE: mid.isAuthed does NOT perform any testing to see if the token
 * provided by the user is valid for the solution. Do not display sensitive information
 * until AFTER your solution has determined the validity of the token by calling
 * a protected API endpoint!
 */
const isAuthed = await mid.isAuthed();

// this call will suspend until login is complete, regardless if it is hosted or a redirect flow.
const {midfetch, idToken, accessToken, tenant} = await mid.login();

// ...
// use `midfetch` to get some information from an endpoint.
// this call will automatically send the appropriate tenant header as well as access token
const res = await midfetch.get(`${baseUrl}/api/cars`);

console.log(await res.json());

// prints something like: {"cars": [{"make": "honda", "model": "accord", "year": 2015, "condition": "EX"}, ...] 
```

## Contributing

### Guiding Principles

1. Require as few dependencies in the production build as possible
2. Allow the ability to extend the core functionality with UI widgets that enable the integration
of alternate view libraries/frameworks (React, Angular, JQuery, etc)
3. Use es6 syntax
4. Add Typescript interfaces where appropriate
5. Write tests to cover new code

### Concepts

#### Drivers

Drivers allow us to abstract away the details of integrations with different OIDC (and eventually SAML) Identity Providers
such that our system is compatible with pluggable IdP integrations.

#### Widgets

McKinsey ID allows implementors to select the appropriate widget for their UI framework/technology, as well as login method. 

A `hosted` widget does not redirect the user from the current page, and submits user's credentials
in the background.

A `redirect` widget will transfer control of the user's browser to the Identity Provider (eg. Okta, Auth0) 
in order to collect their credentials.

*Currently Available Widgets*

_React/Redirect_
_Angular/Redirect_
_Swift/Redirect_

*Planned Widgets*

_React/Hosted_
_Angular/Hosted_
_Elm/Hosted_
_Elm/Redirect_

If you need a specific widget made, please work with us by emailing the [McK/ID Core Team](mailto:mckid_core@mckinsey.com) or by messaging the _\#mckid-support_ slack channel. 

### Developer Workflow

We follow gitflow.

`develop` and `master` are pristine, all feature work should be performed in feature branches with the format:

`feature/ID-xxx_some-feature`

where `ID-xxx` is the JIRA ticket and `some-feature` is a simple name for the feature.

We recommend using [Hubflow Tools](https://datasift.github.io/gitflow/TheHubFlowTools.html) to help automate the workflow.

Pull Requests will trigger CircleCI builds and those will report failure if the tests do not pass

### Testing

Per details that I found while browsing the Okta github org, it appears that best practice is to have a sandbox/preview
Okta org for testing. We will do the same for Auth0 as well.

`yarn test`

We use:

* [ESLint](https://eslint.org/) for linting
* [Jest](https://facebook.github.io/jest/) for unit testing
* [JSVerify](http://jsverify.github.io) for property testing
* [Puppeteer](https://github.com/GoogleChrome/puppeteer) for functional testing

### User-facing Error Codes

In order to support enterprise adoption and ease helpdesk support, below are the set of human-readable 
error codes that can be provided to helpdesk personnel to assist in diagnostics and support. 

Example:

`A00` is a Credential failure (bad username/password)

#### Authentication & user entry failures (Axx level)

| Code | Definition |
| ---- | ---------- |
| A00  | Invalid username / password or other credential |
| A01  | User locked out |
| A02  | Password expired |
| A03  | MFA Challenge Unsuccessful |

#### User Environment-related failures (Bxx level) 

These codes will appear when a network connection has failed. Changing networks may resolve the issues.

| Code | Definition |
| ---- | ---------- |
| B00  | Attempt to call the emailToLoginInfo callback failed |
| B01  | Connection failure to the IdP (eg. Okta, Auth0) |
| B02  | Rate limiting by 3rd party |
| B03  | Unable to retrieve OIDC or SAML Metadata for self-configuration. This may be due to misconfiguration |
| B04  | Temporary failure at IdP (ie. connection succeeded but another temporary failure occurred) |
| B05  | Tokens provided by IdP are missing or invalid, try again |
| B06  | Attempt to call user provided tenant selection callback failed |
| B07  | Unable to retrieve access token from the provided authorization code |

#### Hard errors (Fxx level)

These errors are usually unrecoverable (bugs, protocol incompatibilities, unknown error states)

| Code | Definition |
| ---- | ---------- |
| F00 | Unhandled Error |
| F01 | Invalid request to IdP |
| F02 | Invalid request to MFA |
| F03 | Bad configuration provided to mid-sdk, unable to start |
| F04 | Missing Auth Driver |
| F05 | Unsupported feature |
